# `outfiles` Module

## Overview

The `outfiles` module, located in `src/outfiles.f90`, is responsible for writing all the major output files generated by the `disorder` program. It takes the processed data, such as symmetry matrices, configurations, and structural information, and formats it into human-readable or machine-readable files. The main subroutine `output` calls specialized subroutines for each type of file.

## Main Subroutine

*   **`output(eqamat, leqa, spgmat, lspg, iconf, deg, k, lcfg, a, x, atom, natom, symbols, site, lpos)`**:
    *   **Description**: This is the primary entry point for the module. It checks boolean flags (`leqa`, `lspg`, `lcfg`, `lpos`) to determine which output files need to be generated and calls the appropriate subroutines.
    *   **Arguments**:
        *   `eqamat` (Integer(2), Intent(in)): Equivalency matrix.
        *   `leqa` (Logical(1), Intent(in)): Flag to write `EQAMAT` file.
        *   `spgmat` (Real(8), Intent(in)): Space group matrices.
        *   `lspg` (Logical(1), Intent(in)): Flag to write `SPGMAT` file.
        *   `iconf` (Integer(2), Intent(in)): Irreducible configurations.
        *   `deg` (Integer(2), Intent(in)): Degeneracies of configurations.
        *   `k` (Integer(2), Intent(in)): Number of atoms of each substituting species.
        *   `lcfg` (Logical(1), Intent(in)): Flag to write `CFGMAT` file.
        *   `a` (Real(8), Intent(in)): Lattice vectors.
        *   `x` (Real(8), Intent(in)): Atomic coordinates of the parent cell.
        *   `atom` (Character(len=2), Intent(in)): Atom symbols of the parent cell.
        *   `natom` (Integer(2), Intent(in)): Number of atoms of each type in the parent cell.
        *   `symbols` (Character(len=2), Intent(in)): Symbols of the substituting species.
        *   `site` (Integer(1), Intent(in)): Index of the site being substituted.
        *   `lpos` (Logical(1), Intent(in)): Flag to write `POSCAR` files for each configuration.
    *   **Logic**:
        1.  Prints a message "Writing output files :".
        2.  Removes existing output files/directories (`EQAMAT`, `SPGMAT`, `CFGMAT`, `poscar/`) using `call system(...)` to prevent appending or errors.
        3.  If `leqa` is true, calls `outeqamat`.
        4.  If `lspg` is true, calls `outspgmat`.
        5.  If `lcfg` is true, calls `outconfig`.
        6.  If `lpos` is true, calls `outposcar`.
        7.  Prints a newline character to complete the "Writing output files :" line.

## Output File Generation Subroutines

*   **`outeqamat(eqamat)`**:
    *   **Description**: Writes the equivalency matrix to a file named `EQAMAT`.
    *   **Arguments**:
        *   `eqamat` (Integer(2), Intent(in)): The `na` x `no` matrix where `na` is the number of atoms on the substitution site and `no` is the number of symmetry operations. `eqamat(i,j)` gives the index of the atom that atom `i` is mapped to by symmetry operation `j`.
    *   **Format**:
        *   Each line corresponds to a symmetry operation.
        *   Contains `na` integers per line, formatted as `I4`.

*   **`outspgmat(spgmat)`**:
    *   **Description**: Writes the space group matrices to a file named `SPGMAT`.
    *   **Arguments**:
        *   `spgmat` (Real(8), Intent(in)): A 3x(3+`nt`)x`nr` array containing rotation matrices and translation vectors for symmetry operations. `nt` is the number of translation vectors per rotation, `nr` is the number of rotation matrices.
    *   **Format**:
        *   The first line indicates the total number of operations (`no = nr * nt`), and the dimensions `nr` and `nt`.
        *   For each of the `nr` rotation matrices:
            *   An empty line.
            *   Three lines representing the 3x3 rotation matrix (integers, `3I4`) followed by `nt` translation vectors (real numbers, `F12.6`).

*   **`outconfig(iconf, deg, k)`**:
    *   **Description**: Writes the generated irreducible configurations and their degeneracies to a file named `CFGMAT`.
    *   **Arguments**:
        *   `iconf` (Integer(2), Intent(in)): An `ns` x `nc` array where `ns` is the number of sites in the supercell being substituted and `nc` is the number of configurations. `iconf(:,i)` contains the indices of the sites occupied by one type of atom for the i-th configuration.
        *   `deg` (Integer(2), Intent(in)): An array of size `nc`, where `deg(i)` is the degeneracy of the i-th configuration.
        *   `k` (Integer(2), Intent(in)): Array indicating the number of atoms of each substituting species. Used to format the output of `iconf` into blocks.
    *   **Format**:
        *   Each line represents one configuration.
        *   Starts with the configuration index (I10) and its degeneracy (I6).
        *   Followed by blocks of integers (`I4`) representing the site indices occupied by each substituting species. The number of integers in each block corresponds to the values in `k`. For example, if `k = (/2, 3/)`, there will be a block of 2 site indices, then a block of 3 site indices.

*   **`outposcar(a, x, atom, natom, symbols, k, site, iconf)`**:
    *   **Description**: Generates individual `POSCAR` (VASP format) files for each irreducible configuration. These files are placed in a subdirectory named `poscar/`.
    *   **Arguments**:
        *   (Many arguments are the same as for `output` and describe the parent cell and substitution details)
        *   `iconf` (Integer(2), Intent(in)): The configurations matrix.
    *   **Logic**:
        1.  Creates a directory `poscar/` (removes it first if it exists).
        2.  Determines the atom types and counts for the new `POSCAR` files based on `atom`, `natom`, `symbols`, and `k`. Handles the special `Kw` (vacancy) symbol.
        3.  For each configuration `i` from `1` to `nc` (number of configurations):
            *   Constructs the list of atomic sites (`nx2`) for the first species in the current configuration `iconf(:,i)`.
            *   If there's a vacancy species (`Kw`), it correctly identifies the sites for actual atoms.
            *   Assembles the new coordinate array `x_new` by taking coordinates of non-substituted atoms (`x1`) and adding the coordinates of the substituted atoms (`x2`) according to the current configuration.
            *   Generates a filename like `poscar/POSCAR-001`, `poscar/POSCAR-002`, etc., with leading zeros based on the total number of configurations.
            *   Calls `writepos` (from the `structure` module) to write the actual `POSCAR` file with lattice vectors `a`, new coordinates `x_new`, new atom symbols `atom_new`, and new atom counts `natom_new`.

## Dependencies

*   **`functions`**:
    *   Uses `width` for formatting integers in `outspgmat` and `outposcar`.
    *   Uses `complement` in `outposcar` to determine non-substituted sites and sites for vacancy species.
*   **`structure`**:
    *   Uses `writepos` subroutine (provided by the `structure` module, though not explicitly listed with `use structure, only: writepos`) within `outposcar` to write VASP-compatible `POSCAR` files.
*   **System Calls**:
    *   Uses `call system(...)` to remove old files/directories and create the `poscar` directory. This makes the output process cleaner by avoiding appending to old files or errors if directories already exist.

This module is the final step in the `disorder` program's workflow, translating the computed symmetry and configuration data into persistent files for analysis or use in further simulations.
